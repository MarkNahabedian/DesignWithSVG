<html>
  <head>
    <title>Design a Nametag to be Made on Shaper Origin</title>
    <style type="text/css">

.debug-paths  { fill: none; stroke: black; stroke-width: 0.02; }

    </style>
    <script type="text/javascript" src="../common/svg_lib.js"></script>
    <script type="text/javascript" src="../hershey/render_text.js"></script>
    <script type="text/javascript">
//<![CDATA[

function makeEmpty(element) {
  var children = element.childNodes;
  for (var i = children.length - 1; i >= 0; i--) {
    element.removeChild(children[i]);
  }
  return element;
}


function inchRect() {
  // Show how big an inch is:
  var rect = document.createElementNS(svgURI, 'rect');
  rect.setAttribute('x', '0');
  rect.setAttribute('y', '0');
  rect.setAttribute('width', '1');
  rect.setAttribute('height', '1');
  rect.setAttribute('fill', 'none');
  rect.setAttribute('stroke', 'blue');
  rect.setAttribute('stroke-width', '.01');
  return rect;
}


// parseKerning parses a string representing the additional X advance
// between two characters.  The input string consists of one line per
// pair of characters.  Each line starts with the two characters to
// adjust the spacing for.  Those are followed by whitespace and a number.
// This is parsed into a javascript map (associative array) associating
// two character strings (the character pairs) with a numeric spacing.
function parseKerning(kerning) {
  var k = {};
  var re = /([a-zA-Z0-9]{2}) +([0-9]+(.[0-9]*)?)/;
  var lines = kerning.split('\n');
  for (var i = 0; i < lines.length; i++) {
    var line = lines[i];
    var m = line.match(re);
    if (m) {
      k[m[1]] = Number(m[2]);
    }
  }
  return k;
}


// The user can specify a set of decorators which successively wrap
// the textgroup.  Each layer adds the previous layer as the child of
// a new group, translating and scaling it as needed, adds additional
// graphics to that group and returns the group.
// It is assumed (and apparently required in order to get a meaningful
// BBox) that child is already linked to the appropriate parent.  Each
// layer of decoration inserts itself between the node passed as its
// child argument and that child's parent.
var decorators = {
  'rectangle':
  function(xmargin, ymargin, roundX, roundY) {
    return function(child) {
      var parent = child.parentNode;
      var bbox = child.getBBox();
      childg = document.createElementNS(svgURI, 'g');
      childg.appendChild(document.createComment('rectangle ' +
          xmargin + ' ' + ymargin));
      parent.removeChild(child);
      childg.appendChild(child);
      childg.setAttribute('transform',
        'translate(' + (xmargin - bbox.x) + ', ' + (ymargin - bbox.y) + ')');
      var g = document.createElementNS(svgURI, 'g');
      g.appendChild(childg);
      parent.appendChild(g);
      var rect = document.createElementNS(svgURI, 'rect');
      rect.setAttribute('x', '0');
      rect.setAttribute('y', '0');
      rect.setAttribute('width', '' + (bbox.width + 2 * xmargin));
      rect.setAttribute('height', '' + (bbox.height + 2 * ymargin));
      if (roundX && roundY) {
        rect.setAttribute('rx', '' + roundX);
        rect.setAttribute('ry', '' + roundY);
      }
      rect.setAttribute('fill', 'none');
      rect.setAttribute('stroke', 'black');
      rect.setAttribute('stroke-width', '0.01');
      g.appendChild(rect);
      return g;
    };
  },
};


function parseDecorator(decostr) {
  var split = decostr.split(' ');
  var tokens = [];
  for (var i = 0; i < split.length; i++) {
    var s = split[i];
    if (s.length == 0) {
      continue;
    }
    var num = Number(s);
    if (isNaN(num)) {
      tokens.push(s);
    } else {
      tokens.push(num);
    }
  }
  if (tokens.length <= 0) {
    return null;
  }
  var op = decorators[tokens.shift()];
  if (!op) {
    return null;
  }
  return op.apply(null, tokens)
}

function parseDecorators(s) {
  var split = s.split('\n');
  var decorators = [];
  for (var i = 0; i < split.length; i++) {
    var d = parseDecorator(split[i]);
    if (d) {
      decorators.push(d);
    }
  }
  return decorators;
}


function renderPage(font, kerning, decorations, name) {
  var dimensions = document.getElementById('dimensions');
  var code = document.getElementById('code');
  var svg = document.getElementById('image');
  makeEmpty(dimensions);
  makeEmpty(code);
  makeEmpty(svg);
  svg.removeAttribute('width');
  svg.removeAttribute('height');
  svg.removeAttribute('viewbox');

  var wholegroup = document.createElementNS(svgURI, 'g');
  svg.appendChild(wholegroup);
  var textgroup = document.createElementNS(svgURI, 'g');
  textgroup.setAttribute('stroke', 'black');
  textgroup.setAttribute('fill', 'none');
  textgroup.setAttribute('stroke-width', '1');
  renderText(textgroup, font, name, kerning);
  // Add decoration
  var decorateme = textgroup;
  wholegroup.appendChild(decorateme);
  for (i = 0; i < decorations.length; i++) {
    var bbox = decorateme.getBBox();
    decorateme.appendChild(document.createComment(
        ' x: ' + bbox.x + '  y: ' + bbox.y +
        '  width: ' + bbox.width + '  height: ' + bbox.height));
    var d = decorations[i](decorateme);
    if (d) {
      decorateme = d;
    }
  }

  wholegroup.appendChild(inchRect());

  var bbox = wholegroup.getBBox();
  console.log('wholegroup bbox: ' + bbox.width + ' ' + bbox.height);
  svg.setAttribute('width', '' + bbox.width + 'in');
  svg.setAttribute('height', '' + bbox.height + 'in');
  svg.setAttribute('viewBox', '' + bbox.x + ' ' + bbox.y + ' ' +
                   bbox.width + ' ' + bbox.height);
  dimensions.appendChild(document.createTextNode(
      'Width: ' + bbox.width +
      '\nHeight: ' + bbox.height));
  showSVG(svg, code);
}


// doUpdate is called when the update button is clicked.
function doUpdate() {
  saveFormValues();
  var fontinput = document.getElementById('font');
  var nameinput = document.getElementById('text');
  var kerninginput = document.getElementById('kerning');
  var decoinput = document.getElementById('decoration');
  var name = nameinput.value;

  var reader = new FileReader();
  reader.onload = function(e) {
    var font = JSON.parse(reader.result);
    var kerning = parseKerning(kerninginput.value);
    var decos = parseDecorators(decoinput.value);
    renderPage(font, kerning, decos, name);
  }
  reader.readAsText(fontinput.files[0]);
}


function saveFormValues() {
  var inputs = document.querySelectorAll('input,textarea');
  for (var i = 0; i < inputs.length; i++) {
    var input = inputs[i];
    var id = input.getAttribute('id');
    if (id) {
      sessionStorage.setItem(id, JSON.stringify(input.value));
    }
  }
/*
  sessionStorage.setItem('text', JSON.stringify(document.getElementById('text').value));
  sessionStorage.setItem('kerning', JSON.stringify(document.getElementById('kerning').value));
  sessionStorage.setItem('font', JSON.stringify(document.getElementById('font').files));
*/
}


// ***** Neither of these seem to work:
window.onbeforeunloaded = saveFormValues;
document.addEventListener("beforeunloaded", saveFormValues, false);


function formDefaults() {
  var fontinput = document.getElementById('font');
  var nameinput = document.getElementById('text');
  var kerninginput = document.getElementById('kerning');
  var decoinput = document.getElementById('decoration');
  var params = (new URL(document.location)).searchParams;
  
  nameinput.value = JSON.parse(sessionStorage.getItem('text'));
  kerninginput.value = JSON.parse(sessionStorage.getItem('kerning'));
  decoinput.value = JSON.parse(sessionStorage.getItem('decoration'));

  // fontinput.value = JSON.parse(sessionStorage.getItem('font'));
  /*
  var dt = ataTransfer();
  
  fontinput.files = dt.files;
  */
}


document.addEventListener("DOMContentLoaded", formDefaults, false);


//]]>
    </script>
  </head>
  <body>
    <form>
      <p>
        Select a single stroke Hershey font expressed in a JSON file
        local to your computer.  See 
        <a href="https://github.com/MarkNahabedian/DesignWithSVG/tree/master/hershey">
          https://github.com/MarkNahabedian/DesignWithSVG/tree/master/hershey
        </a>
        for how to get a single font file.
      </p>
      <p>Font file: <input id="font" name="font" type="file"/></p>
      <p>Text: <input id="text" name="text" type="text" size="30"/></p>
      <p>Kerning:<br/><textarea id="kerning" name="kerning" rows="10" cols="30"></textarea></p>
      <p>Decoration:<br/><textarea id="decoration" name="decoration" rows="10" cols="30"></textarea></p>
      <p><input type="button" value="Update" onClick='doUpdate();'/></p>
    </form>
    <pre id="dimensions"></pre> 
    <pre id="code"></pre>
    <svg id="image" xmlns="http://www.w3.org/2000/svg"></svg>
  </body>
</html>
