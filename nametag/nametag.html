<html>
  <head>
    <title>Design a Nametag to be Made on Shaper Origin</title>
    <style type="text/css">

.debug-paths  { fill: none; stroke: black; stroke-width: 0.02; }

    </style>
    <script type="text/javascript" src="../common/svg_lib.js"></script>
    <script type="text/javascript" src="../hershey/render_text.js"></script>
    <script type="text/javascript">
//<![CDATA[

function makeEmpty(element) {
  var children = element.childNodes;
  for (var i = children.length - 1; i >= 0; i--) {
    element.removeChild(children[i]);
  }
  return element;
}


// parseKerning parses a string representing the additional X advance
// between two characters.  The input string consists of one line per
// pair of characters.  Each line starts with the two characters to
// adjust the spacing for.  Those are followed by whitespace and a number.
// This is parsed into a javascript map (associative array) associating
// two character strings (the character pairs) with a numeric spacing.
function parseKerning(kerning) {
  var k = {};
  var re = /([a-zA-Z0-9]{2}) +([0-9]+(.[0-9]*)?)/;
  var lines = kerning.split('\n');
  for (var i = 0; i < lines.length; i++) {
    var line = lines[i];
    var m = line.match(re);
    if (m) {
      k[m[1]] = Number(m[2]);
    }
  }
  return k;
}


function renderPage(font, kerning, name) {
  var dimensions = document.getElementById('dimensions');
  var code = document.getElementById('code');
  var svg = document.getElementById('image');
  makeEmpty(dimensions);
  makeEmpty(code);
  makeEmpty(svg);

  var wholegroup = document.createElementNS(svgURI, 'g');
  svg.appendChild(wholegroup);
  var textgroup = document.createElementNS(svgURI, 'g');
  wholegroup.appendChild(textgroup);
  textgroup.setAttribute('stroke', 'black');
  textgroup.setAttribute('fill', 'none');
  textgroup.setAttribute('stroke-width', '1');
  renderText(textgroup, font, name, kerning);
  // *** TODO:  Add borders and outside cut path
  var rect = document.createElementNS(svgURI, 'rect');
  wholegroup.appendChild(rect);
  rect.setAttribute('x', '0');
  rect.setAttribute('y', '0');
  rect.setAttribute('width', '1');
  rect.setAttribute('height', '1');
  rect.setAttribute('fill', 'none');
  rect.setAttribute('stroke', 'blue');
  rect.setAttribute('stroke-width', '.01');

  var bbox = wholegroup.getBBox();
  svg.setAttribute('width', '' + bbox.width + 'in');
  svg.setAttribute('height', '' + bbox.height + 'in');
  svg.setAttribute('viewBox', '' + bbox.x + ' ' + bbox.y + ' ' +
                   bbox.width + ' ' + bbox.height);
  dimensions.appendChild(document.createTextNode(
      'Width: ' + bbox.width +
      '\nHeight: ' + bbox.height));
  showSVG(svg, code);
}


// doUpdate is called when the update button is clicked.
function doUpdate() {
  saveFormValues();
  var fontinput = document.getElementById('font');
  var nameinput = document.getElementById('text');
  var kerninginput = document.getElementById('kerning');
  var dimensions = document.getElementById('dimensions');
  var name = nameinput.value;

  var reader = new FileReader();
  reader.onload = function(e) {
    var font = JSON.parse(reader.result);
    var kerning = parseKerning(kerninginput.value);
    renderPage(font, kerning, name);
  }
  reader.readAsText(fontinput.files[0]);
}


function saveFormValues() {
  var inputs = document.querySelectorAll('input,textarea');
  for (var i = 0; i < inputs.length; i++) {
    var input = inputs[i];
    var id = input.getAttribute('id');
    if (id) {
      sessionStorage.setItem(id, JSON.stringify(input.value));
    }
  }
/*
  sessionStorage.setItem('text', JSON.stringify(document.getElementById('text').value));
  sessionStorage.setItem('kerning', JSON.stringify(document.getElementById('kerning').value));
  sessionStorage.setItem('font', JSON.stringify(document.getElementById('font').files));
*/
}


document.addEventListener("beforeunloaded", saveFormValues, false);


function formDefaults() {
  var fontinput = document.getElementById('font');
  var nameinput = document.getElementById('text');
  var kerninginput = document.getElementById('kerning');
  var params = (new URL(document.location)).searchParams;
  
  nameinput.value = JSON.parse(sessionStorage.getItem('text'));
  kerninginput.value = JSON.parse(sessionStorage.getItem('kerning'));

  // fontinput.value = JSON.parse(sessionStorage.getItem('font'));
  /*
  var dt = ataTransfer();
  
  fontinput.files = dt.files;
  */
}


document.addEventListener("DOMContentLoaded", formDefaults, false);


//]]>
    </script>
  </head>
  <body>
    <form>
      <p>Font file: <input id="font" name="font" type="file"/></p>
      <p>Text: <input id="text" name="text" type="text" size="30"/></p>
      <p>Kerning:<br/><textarea id="kerning" name="kerning" rows="10" cols="30"></textarea></p>
      <p><input type="button" value="Update" onClick='doUpdate();'/></p>
    </form>
    <pre id="dimensions"></pre> 
    <pre id="code"></pre>
    <svg id="image" xmlns="http://www.w3.org/2000/svg"></svg>
  </body>
</html>
